#!/bin/bash -e

# A lot like:
# aws ec2 describe-instances --query "Reservations[].Instances[?Tags[?Key == 'qn:roles' && contains(Value, ':bastion:')][] ][].PublicIpAddress" | jq -r '.[]'

# TAG_NAME="qn:roles"
# TAG_SUBVALUE="bastion"
# ATTRIBUTE="PublicIpAddress"

TAG_NAME="$1"
TAG_SUBVALUE="$2"
ATTRIBUTE="$3"

TQUERY="?Key == '${TAG_NAME}' && contains(Value, ':${TAG_SUBVALUE}:')"

if [[ -n "$ATTRIBUTE" ]]; then
  aws ec2 describe-instances --filters Name=instance-state-name,Values=running --query "Reservations[].Instances[?Tags[${TQUERY}][] ][].${ATTRIBUTE}" | jq -r '.[]'
else
  aws ec2 describe-instances --filters Name=instance-state-name,Values=running --query "Reservations[].Instances[?Tags[${TQUERY}][] ][]"
  # Pipe to, for example:  | jq -r '.[].InstanceId'
fi


